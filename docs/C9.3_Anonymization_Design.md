# C9.3 Anonymization Module Design

## 1. Goals
- Implement opt-in anonymization for sensitive data, specifically `source_id`.
- Utilize salted HMAC for irreversible and secure data protection.
- Provide a command-line interface (CLI) tool for easy data ingestion with anonymization options.

## 2. Anonymization Module (`scripts/anonymize.py`)

### 2.1 Functionality
- A function `anonymize_data(data, salt, fields_to_anonymize)` that takes a dictionary (representing a heartbeat log entry), a salt, and a list of fields to anonymize.
- For each field to anonymize, it will compute a salted HMAC of the original value.
- The original value will be replaced with the HMAC.

### 2.2 Salt Management
- The salt should be securely managed and not hardcoded.
- For initial implementation, it can be read from an environment variable or a configuration file.

### 2.3 HMAC Implementation
- Use `hmac` and `hashlib` Python libraries.
- Recommended algorithm: SHA256.

## 3. CLI Ingest Helper (`scripts/ingest_heartbeat.py`)

### 3.1 Functionality
- A command-line tool that reads heartbeat log entries (e.g., from stdin or a file).
- Provides an `--anonymize` flag to enable anonymization.
- If `--anonymize` is used, it will prompt for or read the salt.
- It will then call the `anonymize_data` function for each log entry before writing it to the `heart_ledger.jsonl`.

### 3.2 Opt-in Mechanism
- The `--anonymize` flag will control whether the anonymization process is applied.
- If the flag is not present, data will be ingested as-is.

### 3.3 Data Flow
1. Read raw heartbeat data.
2. If `--anonymize` flag is present:
   a. Obtain salt.
   b. Anonymize specified fields (e.g., `source_id`).
3. Write processed (anonymized or original) data to `heart_ledger.jsonl`.

## 4. Integration with Existing Components
- The `validate_heart.py` script should still be able to validate the schema of anonymized data (the type of `source_id` will remain string).
- The `aggregate_heart.py` script should be able to process anonymized `source_id` values (they will be consistent hashes).

## 5. Security Considerations
- Ensure salt is not exposed.
- HMAC provides one-way hashing, preventing reconstruction of original data.

## 6. Next Steps
- Implement `scripts/anonymize.py`.
- Implement `scripts/ingest_heartbeat.py`.
- Develop unit and integration tests.
- Update documentation and CI/CD.

